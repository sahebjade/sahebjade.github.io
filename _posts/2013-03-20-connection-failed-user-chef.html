---
layout: post
title: 'Connection failed - user: chef - (Bunny::ProtocolError)'
date: '2013-03-20T09:32:00.001-07:00'
author: Sahebjade
tags: 
modified_time: '2013-03-20T09:36:52.583-07:00'
blogger_id: tag:blogger.com,1999:blog-7698498077434061562.post-568581403917469591
blogger_orig_url: http://www.sahebjade.in/2013/03/connection-failed-user-chef.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">I was trying to setup chef server on my local box using Oracle Enterprise Linux 6.4. <o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">After sucessfully installing all the required serivces chef-server was not running, so when I tried to start the service below error was displayed.<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><b style="mso-bidi-font-weight: normal;"><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;">Chef-server dead but pid file exists<o:p></o:p></span></b></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">I tried to find the cause of this issue in logs but no clues in the logs as well.<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">Then I run the chef server in foreground using the below command, to debug the issue<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-family: Courier; font-size: 10pt; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;">#chef-server -C /etc/chef/server.rb -L /var/log/chef/server.log -p 4000 -e production -a thin -P /var/run/chef/server.pid -u chef -G chef</span><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">Below stack trace was displayed<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: Courier; font-size: 10pt; mso-bidi-font-family: &quot;Courier New&quot;; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;">merb : chef-server (api) : worker (port 4000) ~ </span><span style="font-family: &quot;Courier New&quot;; font-size: 10pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-family: Courier; font-size: 10pt; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;">Connection failed - user: chef - (Bunny::ProtocolError)</span><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">This issue was becuase chef server was unable to connect to rabbitmq using bunny protocal as user chef.<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">I had already run the below rabbitmq server configuration which is recommended in opscode site, but still it was failing to connect to rabbitmq<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-family: Courier; font-size: 10pt; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"># rabbitmqctl add_vhost /chef<br /># rabbitmqctl add_user chef <password></password></span><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><br /></span><span style="font-family: Courier; font-size: 10pt; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"># rabbitmqctl set_permissions -p /chef chef ".*" ".*" ".*"</span><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"> <o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">Later I reset the rabbitmq configuration using the following command<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 10pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"># rabbitmqctl force_reset</span><span style="font-family: &quot;Times New Roman&quot;,&quot;serif&quot;; font-size: 12pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">The issue was due to password which was given in server.rb of chef server was different than what I had given while running the rabbitmq server configuration.<o:p></o:p></span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">Basically we should use same password which is set in “amqp_pass” in the Chef server -&nbsp;server.rb file and if you have not given the password in server.rb then the default password is testing.</span></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 0pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 10pt; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"># rabbitmqctl add_vhost /chef<br /># rabbitmqctl add_user chef testing<br /># rabbitmqctl set_permissions -p /chef chef ".*" ".*" ".*" <o:p></o:p></span></div><br /><div class="MsoNormal" style="line-height: normal; margin: 0cm 0cm 6.7pt;"><span style="font-size: 12pt; mso-bidi-font-family: Calibri; mso-bidi-theme-font: minor-latin; mso-fareast-font-family: &quot;Times New Roman&quot;; mso-fareast-language: EN-GB;"><span style="font-family: Calibri;">...at last I was able to start the chef server service and also able to connect to rabbitmq server.<o:p></o:p></span></span></div></div>